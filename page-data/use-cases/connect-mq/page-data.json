{"componentChunkName":"component---src-pages-use-cases-connect-mq-index-mdx","path":"/use-cases/connect-mq/","result":{"pageContext":{"frontmatter":{"title":"Kafka Connect to IBM MQ Sink Connector","description":"Apache Kafka to IBM MQ Sink Connector use case"},"relativePagePath":"/use-cases/connect-mq/index.mdx","titleType":"append","MdxNode":{"id":"80de79b5-1f3d-5caa-a4bd-4ce12688931f","children":[],"parent":"dde4ad41-4f85-5292-bbf6-28908e3c6392","internal":{"content":"---\ntitle: Kafka Connect to IBM MQ Sink Connector\ndescription: Apache Kafka to IBM MQ Sink Connector use case\n---\n\n<InlineNotification kind=\"warning\">\n<strong>Work in progress</strong> - MQ Sink Connector on virtual or baremetal server, MQ and Event Streams on IBM Cloud not completed...\n</InlineNotification>\n\nThis scenario uses the [IBM Kafka Connect sink connector for IBM MQ](https://github.com/ibm-messaging/kafka-connect-mq-sink) to pull streaming data into a MQ queue. We can have multiple deployment combinations but we will limit to two patterns:\n\n<AnchorLinks>\n<AnchorLink>MQ Sink Connector, MQ, Kafka on OpenShift</AnchorLink>\n<AnchorLink>MQ Sink Connector on virtual or baremetal server, MQ and Event Streams on IBM Cloud</AnchorLink>\n</AnchorLinks>\n\n## Pre-requisites\n\n**Get a Git client**\n\n**Clone the MQ Sink connector** using the command:\n\n```shell\ngit clone https://github.com/ibm-messaging/kafka-connect-mq-sink.git\n```\n\n**Clone the Lab repository** to get configuration files. This lab is under [labs/mq-sink-lab/](https://github.com/ibm-cloud-architecture/refarch-eda-tools/tree/master/labs/mq-sink-lab/) folder.\n\n```shell\ngit clone https://github.com/ibm-cloud-architecture/refarch-eda-tools.git\n```\n\n## MQ Sink Connector, MQ, Kafka on OpenShift\n\nThe target deployment looks like in the following diagram:\n\n ![1](./images/all-ocp.png)\n\nKafka is runnning in its own namespace, and we are using Event Streams from Cloud Pack for Integration.\n\n### Pre-requisites\n\nWe assume that you have an instance of Event Streams already running on OpenShift, with a TLS authentication user type. See [those instructions](../../use-cases/overview/pre-requisites#getting-scram-authentication-from-event-streams-on-openshift) to get them.\n\nThe MQ broker is running on OpenShift and was created using kubernetes operators: we have documented a simple how to guide in [this MQ summary](../../technology/mq#installation-with-cloud-pak-for-integration). The instance is exposed via a Route so we can access the administration console using the admin credentials of Cloud Pak for Integration.\n\n### Setup MQ Channel\n\nOpen a shell on the remote container or use the user interface to define the communication channel to use for the Kafka Connection.\n\n* Using CLI: Change the name of the Q manager to reflect what you defined in MQ configuration.\n\n```shell\nrunmqsc EDAQMGR1\n# Define a app channel using server connection\nDEFINE CHANNEL(KAFKA.CHANNEL) CHLTYPE(SVRCONN)\n# Set the channel authentication rules to accept connections requiring userid and password\nSET CHLAUTH(KAFKA.CHANNEL) TYPE(BLOCKUSER) USERLIST('nobody')\nSET CHLAUTH('*') TYPE(ADDRESSMAP) ADDRESS('*') USERSRC(NOACCESS)\nSET CHLAUTH(KAFKA.CHANNEL) TYPE(ADDRESSMAP) ADDRESS('*') USERSRC(CHANNEL) CHCKCLNT(REQUIRED)\n# Set identity of the client connections\nALTER AUTHINFO(SYSTEM.DEFAULT.AUTHINFO.IDPWOS) AUTHTYPE(IDPWOS) ADOPTCTX(YES)\n\nREFRESH SECURITY TYPE(CONNAUTH)\n# Define inventory queue\nDEFINE QLOCAL(INVENTORY)\n# Authorize the IBM MQ user ID to connect to and inquire the queue manager\nSET AUTHREC OBJTYPE(QMGR) PRINCIPAL('admin') AUTHADD(CONNECT,INQ)\n# Authorize the IBM MQ user ID to use the queue:\nSET AUTHREC PROFILE(INVENTORY) OBJTYPE(QUEUE) PRINCIPAL('admin') AUTHADD(ALLMQI)\n# done\nEND\n```\n\n* As an alternate you can use the MQ administration console.\n\nTBD\n\n### Setup Kafka Connect Cluster\n\nConnectors can be added to a Kafka Connect environment using OpenShift CLI commands and the source to image customer resource. We will use the Event Streams admin console to setup kafka connect environment which is based on OpenShift operator. The [Event Streams product documentation](https://ibm.github.io/event-streams/connecting/connectors/) presents the deployment process within the admin console, the `Setup a kafka connect environment` tile guides developer thru those steps:\n\n ![4](./images/es-kconnect.png)\n\n ![5](./images/es-kconn-setup.png)\n\nOnce you downloaded the zip file, which is a yaml manifest, define the configuration for a KafkaConnectS2I instance. The major configuration settings are the server certificate settings and the authentication using Mutual TLS authentication, something like:\n\n```yaml\nspec:\n  bootstrapServers: sandbox-rp-kafka-bootstrap.eventstreams.svc:9093\n  tls:\n    trustedCertificates:\n    - secretName: sandbox-rp-cluster-ca-cert\n      certificate: ca.crt\n  authentication:\n    type: tls\n    certificate: user.crt\n    key: user.key\n    secretName: sandbox-rp-tls-cred\n```\n\nIf you change the name of the connect cluster in the metadata, modify also the name: `spec.template.pod.metadata.annotations. productChargedContainers` accordingly.\n\nThe secrets used above, need to be accessible from the project where the connector is deployed. The simple way to do so is to copy the source certificates from the Event streams project to your current project with the commands like:\n\n```shell\noc get secret  sandbox-rp-cluster-ca-cert  -n eventstreams --export -o yaml | oc apply -f -\noc get secret  sandbox-rp-tls-cred  -n eventstreams --export -o yaml | oc apply -f -\n```\n\nIf you do not have a TLS client certificate from a TLS user, use [this note](../../overview/pre-requisites#getting-tls-authentication-from-event-streams-on-openshift) to create one.\n\n* Deploy the connector cluster\n\n```shell\noc apply -f kafka-connect-s2i.yaml \n```\n\nAn instance of this custom resource represents a Kafka Connect distributed worker cluster. In this mode, workload balancing is automatic, scaling is dynamic, and tasks and data are fault-tolerant. Each connector is represented by another custom resource called KafkaConnector.\n\n```shell\noc describe kafkaconnects2i eda-connect-cluster\n```\n\n### Add the mq-sink connector  \n\nThe [product documentation](https://ibm.github.io/event-streams/connecting/mq/) details the available MQ connectors and the configuration process. Using the event streams console, the process is quite simple to get a connector configuration as json file. Here is an example of the final form to generate the json file:\n\n ![6](./images/es-mq-sink.png)\n\n* Once the json is downloaded, complete the settings\n\n```json\n{\n  \"name\": \"mq-sink\",\n  \"config\":\n  {\n      \"connector.class\": \"com.ibm.eventstreams.connect.mqsink.MQSinkConnector\",\n      \"tasks.max\": \"1\",\n      \"topics\": \"inventory\",\n      \"key.converter\": \"org.apache.kafka.connect.storage.StringConverter\",\n      \"value.converter\": \"org.apache.kafka.connect.storage.StringConverter\",\n      \"mq.queue.manager\": \"EDAQMGR1\",\n      \"mq.connection.name.list\": \"eda-mq-lab-ibm-mq(1414)\",\n      \"mq.user.name\": \"admin\",\n      \"mq.password\": \"passw0rd\",\n      \"mq.user.authentication.mqcsp\": true,\n      \"mq.channel.name\": \"KAFKA.CHANNEL\",\n      \"mq.queue\": \"INVENTORY\",\n      \"mq.message.builder\": \"com.ibm.eventstreams.connect.mqsink.builders.DefaultMessageBuilder\"\n  }\n}\n```\n\n* To run the connector within the cluster, we need to connector jar. You can download this jar file from the Event Stream adming console `> Toolkit > Add connector to your Kafka Connect environment > Add Connector > IBM MQ Connectors`,\n\n ![](./images/es-mq-sink-1.png)\n\nor as an alternate, we [cloned the mq-sink code](https://github.com/ibm-messaging/kafka-connect-mq-sink.git), so a `mvn package` command under `kafka-connect-mq-sink` folder will build the jar. Copy this jar under `cp4i/my-plugins` folder. \n* Build the connector with source to image component.\n\n```\n```\n\n\nWith the correct credentials for IBM EventStreams and IBM MQ, Kafka Connect should connect to both services and pull data from the EventStreams topic configured to the MQ Queue configured.  You will see signs of success in the container output (via oc logs, or in the UI):\n\n```shell\n+ curl -X POST -H Content-Type: application/json http://localhost:8083/connectors --data @/opt/kafka-connect-mq-sink/config/mq-sink.json\n...\n{\"name\":\"mq-sink-connector\",\"config\":{\"connector.class\":\"com.ibm.eventstreams.connect.mqsink.MQSinkConnector\",\"tasks.max\":\"1\",\"topics\":\"inventory\",\"key.converter\":\"org.apache.kafka.connect.storage.StringConverter\",\"value.converter\":\"org.apache.kafka.connect.storage.StringConverter\",\"mq.queue.manager\":\"QM1\",\"mq.connection.name.list\":\"mq-service(1414)\",\"mq.user.name\":\"admin\",\"mq.password\":\"passw0rd\",\"mq.user.authentication.mqcsp\":\"true\",\"mq.channel.name\":\"KAFKA.CHANNEL\",\"mq.queue\":\"INVENTORY\",\"mq.message.builder\":\"com.ibm.eventstreams.connect.mqsink.builders.DefaultMessageBuilder\",\"name\":\"mq-sink-connector\"},\"tasks\":[{\"connector\":\"mq-sink-connector\",\"task\":0}],\"type\":\"sink\"}\n...\n[2020-06-23 04:26:26,054] INFO Creating task mq-sink-connector-0 (org.apache.kafka.connect.runtime.Worker:419)\n...[2020-06-23 04:26:26,449] INFO Connection to MQ established (com.ibm.eventstreams.connect.mqsink.JMSWriter:229)\n[2020-06-23 04:26:26,449] INFO WorkerSinkTask{id=mq-sink-connector-0} Sink task finished initialization and start (org.apache.kafka.connect.runtime.WorkerSinkTask:306)\n```\n\nYou should now have the Kafka Connector MQ Sink running on OpenShift.\n\n\n## MQ Sink Connector on virtual or baremetal server, MQ and Event Streams on IBM Cloud\n\nWe are using our own laptop for the baremetal dedployment, but the current solution will work the same on virtual server.\n\n ![2](./images/hybrid.png)\n\n### Pre-requisites\n\nWe assume that you have an instance of Event Streams already running on IBM Cloud with at least on manager-level credentials created.  The credentials will come in the form of a JSON document as seen in the previous section.\nYou will need the `kafka_brokers_sasl` and `password` atribute to configure the sink connector.\n\nThis scenario uses the `inventory` topic created in the Scenario Setup in previous section.\n\n### Create Local IBM MQ Instance\n\nHere we will use Docker to create a local MQ instance.  First create a data directory to mount in the container.\n\n`mkdir qm1data`\n\nThen create the container.\n\n```shell\ndocker run                     \\\n  --name mq                    \\\n  --detach                     \\\n  --publish 1414:1414          \\\n  --publish 9443:9443          \\\n  --publish 9157:9157          \\\n  --volume qm1data:/mnt/mqm    \\\n  --env LICENSE=accept         \\\n  --env MQ_QMGR_NAME=QM1       \\\n  --env MQ_APP_PASSWORD=admin  \\\n  --env MQ_ENABLE_METRICS=true \\\n  ibmcom/mq\n```\n\nYou should be able to log into the MQ server on port 9443 with default user `admin` and password `passw0rd`.\n\nConnect to the running MQ instance to create a Channel and Queue as described on the [Using IBM MQ with Kafka Connect](https://github.com/ibm-messaging/kafka-connect-mq-sink/blob/master/UsingMQwithKafkaConnect.md) page.\n\n```shell\ndocker exec -ti mq bash\nstrmqm QM1\nrunmqsc QM1\nDEFINE CHANNEL(KAFKA.CHANNEL) CHLTYPE(SVRCONN)\nSET CHLAUTH(KAFKA.CHANNEL) TYPE(BLOCKUSER) USERLIST('nobody')\nSET CHLAUTH('*') TYPE(ADDRESSMAP) ADDRESS('*') USERSRC(NOACCESS)\nSET CHLAUTH(KAFKA.CHANNEL) TYPE(ADDRESSMAP) ADDRESS('*') USERSRC(CHANNEL) CHCKCLNT(REQUIRED)\nALTER AUTHINFO(SYSTEM.DEFAULT.AUTHINFO.IDPWOS) AUTHTYPE(IDPWOS) ADOPTCTX(YES)\nREFRESH SECURITY TYPE(CONNAUTH)\nDEFINE QLOCAL(INVENTORY)\nSET AUTHREC OBJTYPE(QMGR) PRINCIPAL('admin') AUTHADD(CONNECT,INQ)\nSET AUTHREC PROFILE(INVENTORY) OBJTYPE(QUEUE) PRINCIPAL('admin') AUTHADD(ALLMQI)\nEND\n```\n\nExit the session and continue on to create the MQ Connector Sink.\n\n### Create MQ Kafka Connector Sink\n\nThe MQ Connector Sink can be downloaded from [Github](https://github.com/ibm-messaging/kafka-connect-mq-sink).  The Github site includes exhaustive instructions and an abridged version follows.\n\nClone the repository with the following command:\n\n`git clone https://github.com/ibm-messaging/kafka-connect-mq-sink.git`\n\nChange directory into the kafka-connect-mq-sink directory:\n\n`cd kafka-connect-mq-sink`\n\nBuild the connector using Maven:\n\n`mvn clean package`\n\nNext, create a directory to contain the Kafka Connector configuration.\n\n`mkdir config && cd config`\n\nCreate a configuration file called `connect-distributed.properties` for Kafka Connect based on the template below.\n\n```properties\n# A list of host/port pairs to use for establishing the initial connection to the Kafka cluster.\nbootstrap.servers=broker-1- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-0- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-2- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-5- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-3- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093\nssl.enabled.protocols=TLSv1.2\nssl.protocol=TLS\nsecurity.protocol=SASL_SSL\nsasl.mechanism=PLAIN\nsasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"token\" password=\"bA ... Qp\";\n\n# Consumer side configuration\nconsumer.bootstrap.servers=broker-1- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-0- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-2- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-5- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-3- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093\nconsumer.security.protocol=SASL_SSL\nconsumer.ssl.protocol=TLSv1.2\nconsumer.sasl.mechanism=PLAIN\nconsumer.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"token\" password=\"bA ... Qp\";\n\n# Producer Side\nproducer.security.protocol=SASL_SSL\nproducer.ssl.protocol=TLSv1.2\nproducer.sasl.mechanism=PLAIN\nproducer.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"token\" password=\"bA ... Qp\";\nproducer.bootstrap.servers=broker-1- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-0- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-2- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-5- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-3- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093\n\n\nplugin.path=/opt/kafka/libs\n\n# unique name for the cluster, used in forming the Connect cluster group. Note that this must not conflict with consumer group IDs\ngroup.id=mq-sink-cluster\n\n# The converters specify the format of data in Kafka and how to translate it into Connect data. Every Connect user will\n# need to configure these based on the format they want their data in when loaded from or stored into Kafka\nkey.converter=org.apache.kafka.connect.json.JsonConverter\nvalue.converter=org.apache.kafka.connect.json.JsonConverter\n# Converter-specific settings can be passed in by prefixing the Converter's setting with the converter we want to apply\n# it to\nkey.converter.schemas.enable=true\nvalue.converter.schemas.enable=true\n\n# Topic to use for storing offsets. T\noffset.storage.topic=connect-offsets\noffset.storage.replication.factor=3\n#offset.storage.partitions=25\n\n# Topic to use for storing connector and task configurations; note that this should be a single partition, highly replicated, and compacted topic.\nconfig.storage.topic=connect-configs\nconfig.storage.replication.factor=3\n\n# Topic to use for storing statuses. This topic can have multiple partitions and should be replicated and compacted.\nstatus.storage.topic=connect-status\nstatus.storage.replication.factor=3\nstatus.storage.partitions=5\n\n# Flush much faster than normal, which is useful for testing/debugging\noffset.flush.interval.ms=10000\n```\n\nSave this file in the `config` directory.\n\nNext, create a log4j configuration file named `connect-log4j.properties` based on the template below.\n\n```properties\nlog4j.rootLogger=DEBUG, stdout\n\nlog4j.appender.stdout=org.apache.log4j.ConsoleAppender\nlog4j.appender.stdout.layout=org.apache.log4j.PatternLayout\nlog4j.appender.stdout.layout.ConversionPattern=[%d] %p %m (%c:%L)%n\n\nlog4j.logger.org.apache.kafka=INFO\n```\n\nSave this file to the `config` directory as well.\n\nFinally, create a JSON configuraiton file for the MQ sink.  This can be stored anywhere but it can be conveniently created in the `config` directory.  We name this file `mq-sink.json`.\n\n```json\n{\n    \"name\": \"mq-sink\",\n    \"config\":\n    {\n        \"connector.class\": \"com.ibm.eventstreams.connect.mqsink.MQSinkConnector\",\n        \"tasks.max\": \"1\",\n        \"topics\": \"inventory\",\n\n        \"key.converter\": \"org.apache.kafka.connect.storage.StringConverter\",\n        \"value.converter\": \"org.apache.kafka.connect.storage.StringConverter\",\n\n        \"mq.queue.manager\": \"QM1\",\n        \"mq.connection.name.list\": \"mq(1414)\",\n        \"mq.user.name\": \"admin\",\n        \"mq.password\": \"passw0rd\",\n        \"mq.user.authentication.mqcsp\": true,\n        \"mq.channel.name\": \"KAFKA.CHANNEL\",\n        \"mq.queue\": \"INVENTORY\",\n        \"mq.message.builder\": \"com.ibm.eventstreams.connect.mqsink.builders.DefaultMessageBuilder\"\n    }\n}\n```\n\nBack out one directory to the `kafka-connect-mq-sink` directory.\n\n`cd ..`\n\nBuild docker image\n`docker build -t kafkaconnect-with-mq-sink:1.3.0 .`\n\nFinally, run the Kafka Connect MQ Sink container.\n\n```\ndocker run                                 \\\n  --name mq-sink                           \\\n  --detach                                 \\\n  --volume $(pwd)/config:/opt/kafka/config \\\n  --publish 8083:8083                      \\\n  --link mq:mq                             \\\n  kafkaconnect-with-mq-sink:1.3.0\n```\n\nYou should now have a working MQ sink.\n\nAs an alternate approach, when you have a Kafka Connect isntance up and running, with the dependant jar files, it is possible to configure the connector with a POST operation like:\n\n```Shell\ncurl -X POST -H \"Content-Type: application/json\" http://localhost:8083/connectors   --data \"@./mq-sink.json\"\n\n# The response returns the metadata about the connector\n{\"name\":\"mq-sink\",\"config\":{\"connector.class\":\"com.ibm.eventstreams.connect.mqsink.MQSinkConnector\",\"tasks.max\":\"1\",\"topics\":\"inventory\",\"key.converter\":\"org.apache.kafka.connect.storage.StringConverter\",\"value.converter\":\"org.apache.kafka.connect.storage.StringConverter\",\"mq.queue.manager\":\"QM1\",\"mq.connection.name.list\":\"ibmmq(1414)\",\"mq.user.name\":\"admin\",\"mq.password\":\"passw0rd\",\"mq.user.authentication.mqcsp\":\"true\",\"mq.channel.name\":\"KAFKA.CHANNEL\",\"mq.queue\":\"INVENTORY\",\"mq.message.builder\":\"com.ibm.eventstreams.connect.mqsink.builders.DefaultMessageBuilder\",\"name\":\"mq-sink\"},\"tasks\":[{\"connector\":\"mq-sink\",\"task\":0}],\"type\":\"sink\"}\n```\n\nOnce the connector is up and running, we can use some tool to send inventory message. In the `integration-tests` folder we have some python code to produce message. If you have a python environment with kafka api you can use yours, or we have also provided a Dockerfile to prepare a local python environment, which will not impact yours.\n\n```shell\n# if you change the name of the image\ndocker build -t ibmcase/python37 .\n# ... then update the script ./startPython.sh\n./startPython.sh\n# Now in the new bash session you should see ProduceInventoryEvent.py,... start it by sending 2 events\npython ProduceInventoryEvent.py --size 2\n# Events are random but use stores and items known by the database downstream.\n sending -> {'storeName': 'NYC01', 'itemCode': 'IT06', 'quantity': 15, 'price': 163, 'id': 1, 'timestamp': '23-Jun-2020 04:32:38'}\n# the following trace demonstrates Kafka received the message\n[KafkaProducer] - Message delivered to inventory [0]\nsending -> {'storeName': 'SC01', 'itemCode': 'IT06', 'quantity': 15, 'price': 178, 'id': 2, 'timestamp': '23-Jun-2020 04:32:38'}\n[KafkaProducer] - Message delivered to inventory [0]\n```\n\nIn the Kafka Connect trace we can see:\n\n```shell\nkconnect_1  | [2020-06-23 04:23:16,270] INFO WorkerSinkTask{id=mq-sink-0} Committing offsets asynchronously using sequence number 26: {inventory-0=OffsetAndMetadata{offset=44, leaderEpoch=null, metadata=''}} (org.apache.kafka.connect.runtime.WorkerSinkTask:349)\nkconnect_1  | [2020-06-23 04:32:46,382] INFO WorkerSinkTask{id=mq-sink-0} Committing offsets asynchronously using sequence number 83: {inventory-0=OffsetAndMetadata{offset=48, leaderEpoch=null, metadata=''}} (org.apache.kafka.connect.runtime.WorkerSinkTask:349)\n```\n\nAnd in the IBM MQ Console, under the Local Queue: Inventory we can see the messages:\n\n![](./images/ibmq-q-inventory.png)\n\nTo remove the connector do the following command. Do this specially if you go to scenario 2 next.\n\n```shell\ncurl -X DELETE http://localhost:8083/connectors/mq-sink\n```\n","type":"Mdx","contentDigest":"2212441a6d4e2d6c324f800d765e09fa","counter":631,"owner":"gatsby-plugin-mdx"},"exports":[],"rawBody":"---\ntitle: Kafka Connect to IBM MQ Sink Connector\ndescription: Apache Kafka to IBM MQ Sink Connector use case\n---\n\n<InlineNotification kind=\"warning\">\n<strong>Work in progress</strong> - MQ Sink Connector on virtual or baremetal server, MQ and Event Streams on IBM Cloud not completed...\n</InlineNotification>\n\nThis scenario uses the [IBM Kafka Connect sink connector for IBM MQ](https://github.com/ibm-messaging/kafka-connect-mq-sink) to pull streaming data into a MQ queue. We can have multiple deployment combinations but we will limit to two patterns:\n\n<AnchorLinks>\n<AnchorLink>MQ Sink Connector, MQ, Kafka on OpenShift</AnchorLink>\n<AnchorLink>MQ Sink Connector on virtual or baremetal server, MQ and Event Streams on IBM Cloud</AnchorLink>\n</AnchorLinks>\n\n## Pre-requisites\n\n**Get a Git client**\n\n**Clone the MQ Sink connector** using the command:\n\n```shell\ngit clone https://github.com/ibm-messaging/kafka-connect-mq-sink.git\n```\n\n**Clone the Lab repository** to get configuration files. This lab is under [labs/mq-sink-lab/](https://github.com/ibm-cloud-architecture/refarch-eda-tools/tree/master/labs/mq-sink-lab/) folder.\n\n```shell\ngit clone https://github.com/ibm-cloud-architecture/refarch-eda-tools.git\n```\n\n## MQ Sink Connector, MQ, Kafka on OpenShift\n\nThe target deployment looks like in the following diagram:\n\n ![1](./images/all-ocp.png)\n\nKafka is runnning in its own namespace, and we are using Event Streams from Cloud Pack for Integration.\n\n### Pre-requisites\n\nWe assume that you have an instance of Event Streams already running on OpenShift, with a TLS authentication user type. See [those instructions](../../use-cases/overview/pre-requisites#getting-scram-authentication-from-event-streams-on-openshift) to get them.\n\nThe MQ broker is running on OpenShift and was created using kubernetes operators: we have documented a simple how to guide in [this MQ summary](../../technology/mq#installation-with-cloud-pak-for-integration). The instance is exposed via a Route so we can access the administration console using the admin credentials of Cloud Pak for Integration.\n\n### Setup MQ Channel\n\nOpen a shell on the remote container or use the user interface to define the communication channel to use for the Kafka Connection.\n\n* Using CLI: Change the name of the Q manager to reflect what you defined in MQ configuration.\n\n```shell\nrunmqsc EDAQMGR1\n# Define a app channel using server connection\nDEFINE CHANNEL(KAFKA.CHANNEL) CHLTYPE(SVRCONN)\n# Set the channel authentication rules to accept connections requiring userid and password\nSET CHLAUTH(KAFKA.CHANNEL) TYPE(BLOCKUSER) USERLIST('nobody')\nSET CHLAUTH('*') TYPE(ADDRESSMAP) ADDRESS('*') USERSRC(NOACCESS)\nSET CHLAUTH(KAFKA.CHANNEL) TYPE(ADDRESSMAP) ADDRESS('*') USERSRC(CHANNEL) CHCKCLNT(REQUIRED)\n# Set identity of the client connections\nALTER AUTHINFO(SYSTEM.DEFAULT.AUTHINFO.IDPWOS) AUTHTYPE(IDPWOS) ADOPTCTX(YES)\n\nREFRESH SECURITY TYPE(CONNAUTH)\n# Define inventory queue\nDEFINE QLOCAL(INVENTORY)\n# Authorize the IBM MQ user ID to connect to and inquire the queue manager\nSET AUTHREC OBJTYPE(QMGR) PRINCIPAL('admin') AUTHADD(CONNECT,INQ)\n# Authorize the IBM MQ user ID to use the queue:\nSET AUTHREC PROFILE(INVENTORY) OBJTYPE(QUEUE) PRINCIPAL('admin') AUTHADD(ALLMQI)\n# done\nEND\n```\n\n* As an alternate you can use the MQ administration console.\n\nTBD\n\n### Setup Kafka Connect Cluster\n\nConnectors can be added to a Kafka Connect environment using OpenShift CLI commands and the source to image customer resource. We will use the Event Streams admin console to setup kafka connect environment which is based on OpenShift operator. The [Event Streams product documentation](https://ibm.github.io/event-streams/connecting/connectors/) presents the deployment process within the admin console, the `Setup a kafka connect environment` tile guides developer thru those steps:\n\n ![4](./images/es-kconnect.png)\n\n ![5](./images/es-kconn-setup.png)\n\nOnce you downloaded the zip file, which is a yaml manifest, define the configuration for a KafkaConnectS2I instance. The major configuration settings are the server certificate settings and the authentication using Mutual TLS authentication, something like:\n\n```yaml\nspec:\n  bootstrapServers: sandbox-rp-kafka-bootstrap.eventstreams.svc:9093\n  tls:\n    trustedCertificates:\n    - secretName: sandbox-rp-cluster-ca-cert\n      certificate: ca.crt\n  authentication:\n    type: tls\n    certificate: user.crt\n    key: user.key\n    secretName: sandbox-rp-tls-cred\n```\n\nIf you change the name of the connect cluster in the metadata, modify also the name: `spec.template.pod.metadata.annotations. productChargedContainers` accordingly.\n\nThe secrets used above, need to be accessible from the project where the connector is deployed. The simple way to do so is to copy the source certificates from the Event streams project to your current project with the commands like:\n\n```shell\noc get secret  sandbox-rp-cluster-ca-cert  -n eventstreams --export -o yaml | oc apply -f -\noc get secret  sandbox-rp-tls-cred  -n eventstreams --export -o yaml | oc apply -f -\n```\n\nIf you do not have a TLS client certificate from a TLS user, use [this note](../../overview/pre-requisites#getting-tls-authentication-from-event-streams-on-openshift) to create one.\n\n* Deploy the connector cluster\n\n```shell\noc apply -f kafka-connect-s2i.yaml \n```\n\nAn instance of this custom resource represents a Kafka Connect distributed worker cluster. In this mode, workload balancing is automatic, scaling is dynamic, and tasks and data are fault-tolerant. Each connector is represented by another custom resource called KafkaConnector.\n\n```shell\noc describe kafkaconnects2i eda-connect-cluster\n```\n\n### Add the mq-sink connector  \n\nThe [product documentation](https://ibm.github.io/event-streams/connecting/mq/) details the available MQ connectors and the configuration process. Using the event streams console, the process is quite simple to get a connector configuration as json file. Here is an example of the final form to generate the json file:\n\n ![6](./images/es-mq-sink.png)\n\n* Once the json is downloaded, complete the settings\n\n```json\n{\n  \"name\": \"mq-sink\",\n  \"config\":\n  {\n      \"connector.class\": \"com.ibm.eventstreams.connect.mqsink.MQSinkConnector\",\n      \"tasks.max\": \"1\",\n      \"topics\": \"inventory\",\n      \"key.converter\": \"org.apache.kafka.connect.storage.StringConverter\",\n      \"value.converter\": \"org.apache.kafka.connect.storage.StringConverter\",\n      \"mq.queue.manager\": \"EDAQMGR1\",\n      \"mq.connection.name.list\": \"eda-mq-lab-ibm-mq(1414)\",\n      \"mq.user.name\": \"admin\",\n      \"mq.password\": \"passw0rd\",\n      \"mq.user.authentication.mqcsp\": true,\n      \"mq.channel.name\": \"KAFKA.CHANNEL\",\n      \"mq.queue\": \"INVENTORY\",\n      \"mq.message.builder\": \"com.ibm.eventstreams.connect.mqsink.builders.DefaultMessageBuilder\"\n  }\n}\n```\n\n* To run the connector within the cluster, we need to connector jar. You can download this jar file from the Event Stream adming console `> Toolkit > Add connector to your Kafka Connect environment > Add Connector > IBM MQ Connectors`,\n\n ![](./images/es-mq-sink-1.png)\n\nor as an alternate, we [cloned the mq-sink code](https://github.com/ibm-messaging/kafka-connect-mq-sink.git), so a `mvn package` command under `kafka-connect-mq-sink` folder will build the jar. Copy this jar under `cp4i/my-plugins` folder. \n* Build the connector with source to image component.\n\n```\n```\n\n\nWith the correct credentials for IBM EventStreams and IBM MQ, Kafka Connect should connect to both services and pull data from the EventStreams topic configured to the MQ Queue configured.  You will see signs of success in the container output (via oc logs, or in the UI):\n\n```shell\n+ curl -X POST -H Content-Type: application/json http://localhost:8083/connectors --data @/opt/kafka-connect-mq-sink/config/mq-sink.json\n...\n{\"name\":\"mq-sink-connector\",\"config\":{\"connector.class\":\"com.ibm.eventstreams.connect.mqsink.MQSinkConnector\",\"tasks.max\":\"1\",\"topics\":\"inventory\",\"key.converter\":\"org.apache.kafka.connect.storage.StringConverter\",\"value.converter\":\"org.apache.kafka.connect.storage.StringConverter\",\"mq.queue.manager\":\"QM1\",\"mq.connection.name.list\":\"mq-service(1414)\",\"mq.user.name\":\"admin\",\"mq.password\":\"passw0rd\",\"mq.user.authentication.mqcsp\":\"true\",\"mq.channel.name\":\"KAFKA.CHANNEL\",\"mq.queue\":\"INVENTORY\",\"mq.message.builder\":\"com.ibm.eventstreams.connect.mqsink.builders.DefaultMessageBuilder\",\"name\":\"mq-sink-connector\"},\"tasks\":[{\"connector\":\"mq-sink-connector\",\"task\":0}],\"type\":\"sink\"}\n...\n[2020-06-23 04:26:26,054] INFO Creating task mq-sink-connector-0 (org.apache.kafka.connect.runtime.Worker:419)\n...[2020-06-23 04:26:26,449] INFO Connection to MQ established (com.ibm.eventstreams.connect.mqsink.JMSWriter:229)\n[2020-06-23 04:26:26,449] INFO WorkerSinkTask{id=mq-sink-connector-0} Sink task finished initialization and start (org.apache.kafka.connect.runtime.WorkerSinkTask:306)\n```\n\nYou should now have the Kafka Connector MQ Sink running on OpenShift.\n\n\n## MQ Sink Connector on virtual or baremetal server, MQ and Event Streams on IBM Cloud\n\nWe are using our own laptop for the baremetal dedployment, but the current solution will work the same on virtual server.\n\n ![2](./images/hybrid.png)\n\n### Pre-requisites\n\nWe assume that you have an instance of Event Streams already running on IBM Cloud with at least on manager-level credentials created.  The credentials will come in the form of a JSON document as seen in the previous section.\nYou will need the `kafka_brokers_sasl` and `password` atribute to configure the sink connector.\n\nThis scenario uses the `inventory` topic created in the Scenario Setup in previous section.\n\n### Create Local IBM MQ Instance\n\nHere we will use Docker to create a local MQ instance.  First create a data directory to mount in the container.\n\n`mkdir qm1data`\n\nThen create the container.\n\n```shell\ndocker run                     \\\n  --name mq                    \\\n  --detach                     \\\n  --publish 1414:1414          \\\n  --publish 9443:9443          \\\n  --publish 9157:9157          \\\n  --volume qm1data:/mnt/mqm    \\\n  --env LICENSE=accept         \\\n  --env MQ_QMGR_NAME=QM1       \\\n  --env MQ_APP_PASSWORD=admin  \\\n  --env MQ_ENABLE_METRICS=true \\\n  ibmcom/mq\n```\n\nYou should be able to log into the MQ server on port 9443 with default user `admin` and password `passw0rd`.\n\nConnect to the running MQ instance to create a Channel and Queue as described on the [Using IBM MQ with Kafka Connect](https://github.com/ibm-messaging/kafka-connect-mq-sink/blob/master/UsingMQwithKafkaConnect.md) page.\n\n```shell\ndocker exec -ti mq bash\nstrmqm QM1\nrunmqsc QM1\nDEFINE CHANNEL(KAFKA.CHANNEL) CHLTYPE(SVRCONN)\nSET CHLAUTH(KAFKA.CHANNEL) TYPE(BLOCKUSER) USERLIST('nobody')\nSET CHLAUTH('*') TYPE(ADDRESSMAP) ADDRESS('*') USERSRC(NOACCESS)\nSET CHLAUTH(KAFKA.CHANNEL) TYPE(ADDRESSMAP) ADDRESS('*') USERSRC(CHANNEL) CHCKCLNT(REQUIRED)\nALTER AUTHINFO(SYSTEM.DEFAULT.AUTHINFO.IDPWOS) AUTHTYPE(IDPWOS) ADOPTCTX(YES)\nREFRESH SECURITY TYPE(CONNAUTH)\nDEFINE QLOCAL(INVENTORY)\nSET AUTHREC OBJTYPE(QMGR) PRINCIPAL('admin') AUTHADD(CONNECT,INQ)\nSET AUTHREC PROFILE(INVENTORY) OBJTYPE(QUEUE) PRINCIPAL('admin') AUTHADD(ALLMQI)\nEND\n```\n\nExit the session and continue on to create the MQ Connector Sink.\n\n### Create MQ Kafka Connector Sink\n\nThe MQ Connector Sink can be downloaded from [Github](https://github.com/ibm-messaging/kafka-connect-mq-sink).  The Github site includes exhaustive instructions and an abridged version follows.\n\nClone the repository with the following command:\n\n`git clone https://github.com/ibm-messaging/kafka-connect-mq-sink.git`\n\nChange directory into the kafka-connect-mq-sink directory:\n\n`cd kafka-connect-mq-sink`\n\nBuild the connector using Maven:\n\n`mvn clean package`\n\nNext, create a directory to contain the Kafka Connector configuration.\n\n`mkdir config && cd config`\n\nCreate a configuration file called `connect-distributed.properties` for Kafka Connect based on the template below.\n\n```properties\n# A list of host/port pairs to use for establishing the initial connection to the Kafka cluster.\nbootstrap.servers=broker-1- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-0- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-2- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-5- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-3- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093\nssl.enabled.protocols=TLSv1.2\nssl.protocol=TLS\nsecurity.protocol=SASL_SSL\nsasl.mechanism=PLAIN\nsasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"token\" password=\"bA ... Qp\";\n\n# Consumer side configuration\nconsumer.bootstrap.servers=broker-1- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-0- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-2- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-5- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-3- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093\nconsumer.security.protocol=SASL_SSL\nconsumer.ssl.protocol=TLSv1.2\nconsumer.sasl.mechanism=PLAIN\nconsumer.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"token\" password=\"bA ... Qp\";\n\n# Producer Side\nproducer.security.protocol=SASL_SSL\nproducer.ssl.protocol=TLSv1.2\nproducer.sasl.mechanism=PLAIN\nproducer.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"token\" password=\"bA ... Qp\";\nproducer.bootstrap.servers=broker-1- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-0- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-2- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-5- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-3- ... kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093\n\n\nplugin.path=/opt/kafka/libs\n\n# unique name for the cluster, used in forming the Connect cluster group. Note that this must not conflict with consumer group IDs\ngroup.id=mq-sink-cluster\n\n# The converters specify the format of data in Kafka and how to translate it into Connect data. Every Connect user will\n# need to configure these based on the format they want their data in when loaded from or stored into Kafka\nkey.converter=org.apache.kafka.connect.json.JsonConverter\nvalue.converter=org.apache.kafka.connect.json.JsonConverter\n# Converter-specific settings can be passed in by prefixing the Converter's setting with the converter we want to apply\n# it to\nkey.converter.schemas.enable=true\nvalue.converter.schemas.enable=true\n\n# Topic to use for storing offsets. T\noffset.storage.topic=connect-offsets\noffset.storage.replication.factor=3\n#offset.storage.partitions=25\n\n# Topic to use for storing connector and task configurations; note that this should be a single partition, highly replicated, and compacted topic.\nconfig.storage.topic=connect-configs\nconfig.storage.replication.factor=3\n\n# Topic to use for storing statuses. This topic can have multiple partitions and should be replicated and compacted.\nstatus.storage.topic=connect-status\nstatus.storage.replication.factor=3\nstatus.storage.partitions=5\n\n# Flush much faster than normal, which is useful for testing/debugging\noffset.flush.interval.ms=10000\n```\n\nSave this file in the `config` directory.\n\nNext, create a log4j configuration file named `connect-log4j.properties` based on the template below.\n\n```properties\nlog4j.rootLogger=DEBUG, stdout\n\nlog4j.appender.stdout=org.apache.log4j.ConsoleAppender\nlog4j.appender.stdout.layout=org.apache.log4j.PatternLayout\nlog4j.appender.stdout.layout.ConversionPattern=[%d] %p %m (%c:%L)%n\n\nlog4j.logger.org.apache.kafka=INFO\n```\n\nSave this file to the `config` directory as well.\n\nFinally, create a JSON configuraiton file for the MQ sink.  This can be stored anywhere but it can be conveniently created in the `config` directory.  We name this file `mq-sink.json`.\n\n```json\n{\n    \"name\": \"mq-sink\",\n    \"config\":\n    {\n        \"connector.class\": \"com.ibm.eventstreams.connect.mqsink.MQSinkConnector\",\n        \"tasks.max\": \"1\",\n        \"topics\": \"inventory\",\n\n        \"key.converter\": \"org.apache.kafka.connect.storage.StringConverter\",\n        \"value.converter\": \"org.apache.kafka.connect.storage.StringConverter\",\n\n        \"mq.queue.manager\": \"QM1\",\n        \"mq.connection.name.list\": \"mq(1414)\",\n        \"mq.user.name\": \"admin\",\n        \"mq.password\": \"passw0rd\",\n        \"mq.user.authentication.mqcsp\": true,\n        \"mq.channel.name\": \"KAFKA.CHANNEL\",\n        \"mq.queue\": \"INVENTORY\",\n        \"mq.message.builder\": \"com.ibm.eventstreams.connect.mqsink.builders.DefaultMessageBuilder\"\n    }\n}\n```\n\nBack out one directory to the `kafka-connect-mq-sink` directory.\n\n`cd ..`\n\nBuild docker image\n`docker build -t kafkaconnect-with-mq-sink:1.3.0 .`\n\nFinally, run the Kafka Connect MQ Sink container.\n\n```\ndocker run                                 \\\n  --name mq-sink                           \\\n  --detach                                 \\\n  --volume $(pwd)/config:/opt/kafka/config \\\n  --publish 8083:8083                      \\\n  --link mq:mq                             \\\n  kafkaconnect-with-mq-sink:1.3.0\n```\n\nYou should now have a working MQ sink.\n\nAs an alternate approach, when you have a Kafka Connect isntance up and running, with the dependant jar files, it is possible to configure the connector with a POST operation like:\n\n```Shell\ncurl -X POST -H \"Content-Type: application/json\" http://localhost:8083/connectors   --data \"@./mq-sink.json\"\n\n# The response returns the metadata about the connector\n{\"name\":\"mq-sink\",\"config\":{\"connector.class\":\"com.ibm.eventstreams.connect.mqsink.MQSinkConnector\",\"tasks.max\":\"1\",\"topics\":\"inventory\",\"key.converter\":\"org.apache.kafka.connect.storage.StringConverter\",\"value.converter\":\"org.apache.kafka.connect.storage.StringConverter\",\"mq.queue.manager\":\"QM1\",\"mq.connection.name.list\":\"ibmmq(1414)\",\"mq.user.name\":\"admin\",\"mq.password\":\"passw0rd\",\"mq.user.authentication.mqcsp\":\"true\",\"mq.channel.name\":\"KAFKA.CHANNEL\",\"mq.queue\":\"INVENTORY\",\"mq.message.builder\":\"com.ibm.eventstreams.connect.mqsink.builders.DefaultMessageBuilder\",\"name\":\"mq-sink\"},\"tasks\":[{\"connector\":\"mq-sink\",\"task\":0}],\"type\":\"sink\"}\n```\n\nOnce the connector is up and running, we can use some tool to send inventory message. In the `integration-tests` folder we have some python code to produce message. If you have a python environment with kafka api you can use yours, or we have also provided a Dockerfile to prepare a local python environment, which will not impact yours.\n\n```shell\n# if you change the name of the image\ndocker build -t ibmcase/python37 .\n# ... then update the script ./startPython.sh\n./startPython.sh\n# Now in the new bash session you should see ProduceInventoryEvent.py,... start it by sending 2 events\npython ProduceInventoryEvent.py --size 2\n# Events are random but use stores and items known by the database downstream.\n sending -> {'storeName': 'NYC01', 'itemCode': 'IT06', 'quantity': 15, 'price': 163, 'id': 1, 'timestamp': '23-Jun-2020 04:32:38'}\n# the following trace demonstrates Kafka received the message\n[KafkaProducer] - Message delivered to inventory [0]\nsending -> {'storeName': 'SC01', 'itemCode': 'IT06', 'quantity': 15, 'price': 178, 'id': 2, 'timestamp': '23-Jun-2020 04:32:38'}\n[KafkaProducer] - Message delivered to inventory [0]\n```\n\nIn the Kafka Connect trace we can see:\n\n```shell\nkconnect_1  | [2020-06-23 04:23:16,270] INFO WorkerSinkTask{id=mq-sink-0} Committing offsets asynchronously using sequence number 26: {inventory-0=OffsetAndMetadata{offset=44, leaderEpoch=null, metadata=''}} (org.apache.kafka.connect.runtime.WorkerSinkTask:349)\nkconnect_1  | [2020-06-23 04:32:46,382] INFO WorkerSinkTask{id=mq-sink-0} Committing offsets asynchronously using sequence number 83: {inventory-0=OffsetAndMetadata{offset=48, leaderEpoch=null, metadata=''}} (org.apache.kafka.connect.runtime.WorkerSinkTask:349)\n```\n\nAnd in the IBM MQ Console, under the Local Queue: Inventory we can see the messages:\n\n![](./images/ibmq-q-inventory.png)\n\nTo remove the connector do the following command. Do this specially if you go to scenario 2 next.\n\n```shell\ncurl -X DELETE http://localhost:8083/connectors/mq-sink\n```\n","frontmatter":{"title":"Kafka Connect to IBM MQ Sink Connector","description":"Apache Kafka to IBM MQ Sink Connector use case"},"fileAbsolutePath":"/home/runner/work/refarch-eda/refarch-eda/docs/src/pages/use-cases/connect-mq/index.mdx"}}},"staticQueryHashes":["1364590287","2102389209","2102389209","2456312558","2746626797","2746626797","3018647132","3018647132","3037994772","3037994772","63531786","63531786","768070550"]}